<mp-event-target-template-render id='sidebar' template='{{> sidebar_tmpl}}'>
    <template id='sidebar_tmpl'>
        {{#if showbasemaps}}
            <h2>Basemaps</h2>
            
        {{else if showhistoricalmaps}}
            <h2>Historical Maps</h2>

        {{else if showdetails}}

            <div>
              <mp-event-trigger id='event-trigger5' type='Component.TemplateUpdate' data='{"showentities": true}' targets='["sidebar"]'>
                <a href="#">Go back</a>
              </mp-event-trigger>
            </div>


            {{#ifCond type "===" "E39_Actor"}}

              <div>
                <semantic-query query='
                  PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
                  PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                  PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
                  PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
                  PREFIX crmpc: <http://www.cidoc-crm.org/crmpc/>
                  PREFIX arc: <http://archipelago.itatti.harvard.edu/resource/>
                  PREFIX frbroo: <http://iflastandards.info/ns/fr/frbr/frbroo/>
                  
                  SELECT DISTINCT * WHERE {
                    bind(<{{subject}}> as ?subject)
    
                    ?subject crm:P1_is_identified_by ?name.
                    ?name a crm:E41_Appellation;
                          crm:P2_has_type  <https://archipelago.itatti.harvard.edu/resource/type/preferred_name>;
                          rdfs:label ?name_lbl.
                    
                    optional {
                      ?subject crm:P92i_was_brought_into_existence_by ?birth.
                      ?birth a crm:E67_Birth;
                            crm:P4_has_time-span ?birth_date.
                      ?birth_date a crm:E52_Time-Span;
                            crm:P82a_begin_of_the_begin ?birth_date_label
                    }
                    
                    optional {
                      ?subject crm:P1_is_identified_by ?title.
                      ?title a crm:E41_Appellation;
                            crm:P2_has_type  <https://archipelago.itatti.harvard.edu/resource/type/title>;
                            rdfs:label ?title_label.
                        filter(lang(?title_label) = "en")
                    }
                    
                    optional {
                      ?subject crm:P93i_was_taken_out_of_existence_by ?death.
                      ?death a crm:E69_Death;
                            crm:P4_has_time-span ?death_date.
                      ?death_date a crm:E52_Time-Span;
                            crm:P82a_begin_of_the_begin ?death_date_label
                    }

                    optional {
                      ?subject crm:P14i_performed ?activity.
                      ?activity a frbroo:F51_Pursuit;
                        rdfs:label ?activity_label.
                      filter(lang(?activity_label) = "en")
                    }
                  }
                ' template="{{> template}}">
                <template id="template">

                  <h1>{{bindings.0.name_lbl.value}}</h1>

                  {{#if bindings.0.image}}
                    <img class="navigator-icon" src="{{bindings.0.image.value}}" alt=""> 
                  {{else}}
                    <img class="navigator-icon" src="../../assets/icons/E39_Actor.svg" alt="">
                  {{/if}}

                  {{#if bindings.0.title_label}}
                    <p><strong>Title:</strong> {{bindings.0.title_label.value}}</p>  
                  {{/if}}

                  {{#if bindings.0.birth_date_label}}
                    <p><strong>Birth date:</strong> {{dateTimeFormat bindings.0.birth_date_label.value "YYYY-MM-DD"}}</p>
                  {{/if}}

                  {{#if bindings.0.death_date_label}}
                    <p><strong>Death date:</strong> {{dateTimeFormat bindings.0.death_date_label.value "YYYY-MM-DD"}}</p>
                  {{/if}}

                  {{#if bindings.0.activity_label}}
                    <strong>Activities:</strong>
                    <ol>
                      {{#each bindings}}
                        <li>{{activity_label}}</li>
                      {{/each}}
                    </ol>
                  {{/if}}
                  
                </template>
                </semantic-query>

              </div>

            {{/ifCond}}

            {{#ifCond type "===" "E5_Event"}}

              <div>
                <semantic-query
                  query='
                    PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
                    PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                    select distinct ?subject ?name_label ?synopsys_label ?century_label ?century_quarter_label where {
                      bind(<{{subject}}> as ?subject)
                      ?subject a crm:E5_Event;
                              crm:P1_is_identified_by ?name;
                              crm:P129i_is_subject_of ?synopsys.
                      
                      ?name a crm:E41_Appellation;
                            rdfs:label ?name_label.
                      
                      ?synopsys a crm:E73_Information_Object;
                                rdfs:label ?synopsys_label
                      
                      optional {
                        ?subject crm:P4_has_time-span ?time_span_1.
                        ?time_span_1 a crm:E52_Time-Span;
                                    crm:P82_at_some_time_within ?century_label
                      }
                      
                      optional {
                        ?subject crm:P4_has_time-span ?time_span_2.
                        ?time_span_2 a crm:E52_Time-Span;
                                    crm:P1_is_identified_by ?appellation.
                        
                        ?appellation a crm:E49_Time_Appellation;
                                    rdfs:label ?century_quarter_label
                      }
                    }'
                  template="{{> template}}" 
                >
                <template id="template">

                  {{#each bindings}}
                    <h3>{{name_label.value}}</h3>

                    <p>{{synopsys_label.value}}</p>

                    <p>{{century_label.value}}, {{century_quarter_label.value}}</p>

                  {{/each}}
                </template>



                </semantic-query>
              </div>

            {{/ifCond}}

            {{#ifCond type "===" "E22_Man-Made_Object"}}

            <div>
              <semantic-query
                query='
                  PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
                  PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                  select distinct ?subject ?name_label ?construction_date_label ?destruction_date_label where {
                    bind(<{{subject}}> as ?subject)
                    ?subject a crm:E22_Man-Made_Object;
                            rdfs:label ?name_label.
                    
                    optional {
                      ?subject crm:P108i_was_produced_by ?prod.
                      ?prod a crm:E12_Production;
                            crm:P4_has_time-span ?prod_date.

                      ?prod_date a crm:E52_Time-Span;
                                crm:P82a_begin_of_the_begin ?construction_date_label
                    }
                    
                    optional {
                    ?subject crm:P13i_was_destroyed_by ?dest.
                      ?dest a crm:E6_Destruction;
                            crm:P4_has_time-span ?dest_date.
                      ?dest_date a crm:E52_Time-Span;
                                crm:P82b_end_of_the_end ?destruction_date_label
                    }  
                  }
                '
                template="{{> template}}" 
              >
              <template id="template">

                {{#each bindings}}
                  <h3>{{name_label.value}}</h3>

                  <p>{{construction_date_label.value}}</p>

                  <p>{{destruction_date_label.value}}</p>

                {{/each}}
              </template>



              </semantic-query>
            </div>

            {{/ifCond}}

        {{else if showoptions}}
            <h2 id="mapControlsTitle">Map Controls</h2>
            <semantic-map-controls id="search-map-control" target-map-id="search-map" features-taxonomies="use,function,name" features-color-taxonomies="use,function"></semantic-map-controls>
        {{else}}
        <div>
          <h2>Entities</h2>

          <semantic-search>
            <semantic-search-query-constant
              query='
                PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
                PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
                PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                SELECT ?subject ?type ?type_lbl ?name ?bw_start_date ?bw_end_date ?order_start_date ?order_end_date ?use_lbl ?typology_lbl WHERE {

                  {
                    BIND("1697-01-01"^^xsd:dateTime AS ?date)
                    ?subject crm:P1_is_identified_by ?bw_id;
                      rdfs:label ?name;
                      rdf:type ?type;
                      crm:P108i_was_produced_by ?prod;
                      crm:P13i_was_destroyed_by ?desc.

                    ?prod crm:P4_has_time-span ?prod_time.
                    ?prod_time crm:P82a_begin_of_the_begin ?bw_start_date.

                    ?desc crm:P4_has_time-span ?desc_time.
                    ?desc_time crm:P82b_end_of_the_end ?bw_end_date.

                    ?subject crm:P12i_was_present_at ?use.
                    ?use a crm:E5_Event;
                      crm:P2_has_type <https://archipelago.itatti.harvard.edu/resource/type/use>;
                      crm:P2_has_type ?use_type.

                    ?use_type a crm:E55_Type;
                      rdfs:label ?use_lbl.

                    ?use crm:P4_has_time-span ?use_date.
                    ?use_date crm:P82a_begin_of_the_begin ?use_date_start;
                    FILTER (?use_date_start <= ?date)

                    ?use crm:P4_has_time-span ?use_date.
                    ?use_date crm:P82b_end_of_the_end ?use_date_end.
                    FILTER (?use_date_end >= ?date)

                    FILTER (STR(?use_lbl) != "Use")
                    FILTER (lang(?use_lbl) = "en")

                    ?subject crm:P12i_was_present_at ?typology.
                    ?typology a crm:E5_Event;
                      crm:P2_has_type <https://archipelago.itatti.harvard.edu/resource/type/typology>;
                      crm:P2_has_type ?typology_type.

                    ?typology_type a crm:E55_Type;
                      rdfs:label ?typology_lbl.

                    ?typology crm:P4_has_time-span ?typology_date.

                    ?typology_date crm:P82a_begin_of_the_begin ?typology_date_start.
                    FILTER (?typology_date_start <= ?date)

                    ?typology_date crm:P82b_end_of_the_end ?typology_date_end.
                    FILTER (?typology_date_end >= ?date)

                    FILTER (STR(?typology_lbl) != "Typology")
                    FILTER (lang(?typology_lbl) = "en")

                    BIND(?bw_start_date AS ?order_start_date)
                    BIND(?bw_end_date AS ?order_end_date) 

                  }
                  UNION
                  {
                    ?subject crm:P15_was_influenced_by ?bw;
                      crm:P1_is_identified_by ?identifier;
                      crm:P4_has_time-span ?order_date;
                      rdf:type ?type.
                    ?bw crm:P108i_was_produced_by ?prod;
                        crm:P13i_was_destroyed_by ?desc.
                    
                    ?prod crm:P4_has_time-span ?prod_time.
                    ?prod_time crm:P82a_begin_of_the_begin ?bw_start_date.
                    
                    ?desc crm:P4_has_time-span ?desc_time.
                    ?desc_time crm:P82b_end_of_the_end ?bw_end_date.
                    
                    ?identifier rdf:type crm:E41_Appellation;
                      rdfs:label ?name.
                
                    ?order_date a crm:E52_Time-Span;	
                                crm:P82a_begin_of_the_begin ?order_start_date.
                    
                    BIND(?order_start_date as ?order_end_date)
                  }
                  UNION
                  {
                    ?event rdf:type crm:E5_Event;
                        crmpc:P01_has_domain ?domain;
                        crm:P15_was_influenced_by ?bw.
                
                    ?bw crm:P108i_was_produced_by ?prod;
                        crm:P13i_was_destroyed_by ?desc.
              
                    ?prod crm:P4_has_time-span ?prod_time.
                    ?prod_time crm:P82a_begin_of_the_begin ?bw_start_date.
              
                    ?desc crm:P4_has_time-span ?desc_time.
                    ?desc_time crm:P82b_end_of_the_end ?bw_end_date.
              
                    ?domain crmpc:P02_has_range ?subject.
                    ?subject rdf:type ?type;
                              crm:P1_is_identified_by ?appellation.
              
                    ?appellation crm:P2_has_type <https://archipelago.itatti.harvard.edu/resource/type/preferred_name>;
                              rdfs:label ?name.
                
                    OPTIONAL {
                      ?subject crm:P92i_was_brought_into_existence_by ?birth.
                      ?birth rdf:type crm:E67_Birth;
                              crm:P4_has_time-span ?birth_date.
                      ?birth_date crm:P82a_begin_of_the_begin ?order_start_date.
                    }
                  
                    OPTIONAL {
                      ?subject crm:P93i_was_taken_out_of_existence_by ?death.
                      ?death rdf:type crm:E69_Death;
                              crm:P4_has_time-span ?death_date.
                      ?death_date crm:P82a_begin_of_the_begin ?order_end_date.
                    }
                  
                  }
                }
              '
            ></semantic-search-query-constant>

            <semantic-search-result-holder>
              <semantic-search-result>
                <semantic-table
                  id='table'
                  query='
                    PREFIX person: <http://example.com/person/>
                    SELECT distinct ?subject ?type ?type_lbl ?name ?order_start_date ?order_end_date ?use_lbl ?typology_lbl where {
                      bind("1697-01-01"^^xsd:dateTime as ?date).

                      bind(replace(?subject, "http://www.cidoc-crm.org/cidoc-crm/", "") as ?subject)
                      bind(replace(str(?type), "http://www.cidoc-crm.org/cidoc-crm/", "") AS ?type_lbl)

                      filter(?bw_start_date <= ?date)
                      filter(?bw_end_date >= ?date)
                    } ORDER BY ASC(?order_start_date)
                  '
                  tuple-template='{{>resultTemplate}}'
                  options='{"showFilter": false}'
                >
                  <template id='resultTemplate'>
                    
                    {{#ifCond type_lbl.value "===" "E39_Actor"}} 
                    
                      <div class="panel panel-default text-center w-100 {{type_lbl.value}}" title="{{subject.value}}">
                        <div class="panel-body ">
                          <div class="row">
                            <div class="col-sm-3">
                              <img class="navigator-icon" src="../../assets/icons/{{type_lbl.value}}.svg" alt="">
                            </div>
                            <div class="col-sm-9 text-left">

                              <mp-event-trigger id='event-open-details' type='Component.TemplateUpdate' data='{"showdetails": true, "subject": "{{subject.value}}", "type": "{{type_lbl.value}}"}' targets='["sidebar"]'>
                                <a><strong>{{name.value}}</strong></a>
                              </mp-event-trigger>

                              {{#if order_start_date }}
                                <p>
                                  {{dateTimeFormat order_start_date.value "YYYY"}} {{#if order_end_date}} - {{dateTimeFormat order_end_date.value "YYYY"}} {{/if}}
                                </p>
                              {{/if}}

                            </div>
                          </div>
                        </div>
                      </div>

                    {{/ifCond}}

                    {{#ifCond type_lbl.value "===" "E22_Man-Made_Object"}} 
                    
                      <div class="panel panel-default text-center w-100 {{type_lbl.value}}" title="{{subject.value}}">
                        <div class="panel-body ">
                          <div class="row">
                            <div class="col-sm-3">
                              <p><img class="navigator-icon" src="../../assets/icons/{{type_lbl.value}}.svg" alt=""></p>
                            </div>
                            <div class="col-sm-9 text-left">
                              
                              <mp-event-trigger id="event-open-details" type="Component.TemplateUpdate" data='{"showdetails": true, "subject": "{{subject.value}}", "type": "{{type_lbl.value}}"}' targets='["sidebar"]'>
                                <a><strong>{{typology_lbl.value}}</strong></h3></a>
                              </mp-event-trigger>

                              <br>
                              Construction: {{dateTimeFormat order_start_date.value "YYYY"}}
                              <br>
                              Demolition: {{dateTimeFormat order_end_date.value "YYYY"}}
                              <br>
                              Function: Private
                              <br>
                              Use: {{use_lbl.value}}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                    {{/ifCond}}

                    {{#ifCond type_lbl.value "===" "E5_Event"}} 
                      
                      <div class="panel panel-default text-center w-100 {{type_lbl.value}}" title="{{subject.value}}">
                        <div class="panel-body ">
                          <div class="row">
                            <div class="col-sm-3">
                              <img class="navigator-icon" src="../../assets/icons/{{type_lbl.value}}.svg" alt="">
                            </div>
                            <div class="col-sm-9 text-left">
                              <mp-event-trigger id="event-open-details" type="Component.TemplateUpdate" data='{"showdetails": true, "subject": "{{subject.value}}", "type": "{{type_lbl.value}}"}' targets='["sidebar"]'>
                                <a><strong>{{name.value}}</strong></a>
                              </mp-event-trigger>

                              <br>
                              {{#if order_start_date}}
                              {{dateTimeFormat order_start_date.value "YYYY"}}
                              {{/if}}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                    {{/ifCond}}

                </template>
                </semantic-table>
              </semantic-search-result>
            </semantic-search-result-holder>

          </semantic-search>

        </div>
        {{/if}}
    </template>
</mp-event-target-template-render>
<style>
  #navigatorContainer{
    width: 400px!important;
  }

  
  #navigatorContainer h2{
    text-align: center;
  }

  div.E5_Event{
    border-left: 5px solid #F58F84!important;
  }

  div.E22_Man-Made_Object{
    border-left: 5px solid #26A65B!important;
  }

  div.E39_Actor{
    border-left: 5px solid #FFA400!important;
  }

  .navigator-icon{
    height: 30px;
  }

  .w-100{
    width: 100%!important;
  }
</style>
