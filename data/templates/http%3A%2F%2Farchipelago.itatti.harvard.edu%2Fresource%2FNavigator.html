<mp-event-target-template-render id='sidebar' template='{{> sidebar_tmpl}}'>
    <template id='sidebar_tmpl'>
        {{#if showbasemaps}}
            <h2>Basemaps</h2>
            
        {{else if showhistoricalmaps}}
            <h2>Historical Maps</h2>

        {{else if showdetails}}

            <div>
              <mp-event-trigger id='event-trigger5' type='Component.TemplateUpdate' data='{"showentities": true}' targets='["sidebar"]'>
                <a class="btn btn-primary" href="">Go back to entities</a>
              </mp-event-trigger>
            </div>


            {{#ifCond type "===" "E39_Actor"}}

              <div>
                <semantic-query 
                  query='
                  PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
                  PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                  PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
                  PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
                  PREFIX crmpc: <http://www.cidoc-crm.org/crmpc/>
                  PREFIX arc: <http://archipelago.itatti.harvard.edu/resource/>
                  PREFIX frbroo: <http://iflastandards.info/ns/fr/frbr/frbroo/>
                  
                  SELECT DISTINCT * WHERE {
                    bind(<{{subject}}> as ?subject)
    
                    ?subject crm:P1_is_identified_by ?name.
                    ?name a crm:E41_Appellation;
                          crm:P2_has_type  <https://archipelago.itatti.harvard.edu/resource/type/preferred_name>;
                          rdfs:label ?name_lbl.
                    
                    optional {
                      ?subject crm:P92i_was_brought_into_existence_by ?birth.
                      ?birth a crm:E67_Birth;
                            crm:P4_has_time-span ?birth_date.
                      ?birth_date a crm:E52_Time-Span;
                            crm:P82a_begin_of_the_begin ?birth_date_label
                    }
                    

                    
                    optional {
                      ?subject crm:P93i_was_taken_out_of_existence_by ?death.
                      ?death a crm:E69_Death;
                            crm:P4_has_time-span ?death_date.
                      ?death_date a crm:E52_Time-Span;
                            crm:P82a_begin_of_the_begin ?death_date_label
                    }
                  }
                ' template="{{> template}}">
                <template id="template">

                  {{#each bindings}}
                    <h2 id="mapControlsTitle">{{name_lbl.value}}</h2>

                    <!--
                    {{#if image}}
                      <img src="{{image.value}}" alt="">
                    {{else}}
                      <img src="../../assets/icons/E39_Actor.svg" alt="">
                    {{/if}}-->


                    {{#if birth_date_label}}
                      <p><strong>Birth date:</strong> {{dateTimeFormat birth_date_label.value "YYYY-MM-DD"}}</p>
                    {{/if}}

                    {{#if death_date_label}}
                      <p><strong>Death date:</strong> {{dateTimeFormat death_date_label.value "YYYY-MM-DD"}}</p>
                    {{/if}}

                    <semantic-query
                      query='
                        select * where{ 
                          <{{subject.value}}> crm:P1_is_identified_by ?title.
                          ?title a crm:E41_Appellation;
                                crm:P2_has_type  <https://archipelago.itatti.harvard.edu/resource/type/title>;
                                rdfs:label ?title_label.
                            filter(lang(?title_label) = "en")
                        }
                      '
                      template='{{>activities}}'
                    >
                        <template id="activities">
                          <strong>Titles:</strong>
                          <ul>
                            {{#each bindings}}
                              <li>{{title_label.value}}</li>
                            {{/each}}
                          </ul>
                        </template>

                    </semantic-query>


                    <semantic-if query='ASK { <{{subject.value}}> crm:P14i_performed ?activity  }'>
                      <template id='then'>
                        <semantic-query
                          query='
                            select ?activity ?activity_label where{ 
                              <{{subject.value}}> crm:P14i_performed ?activity.
                              ?activity a frbroo:F51_Pursuit;
                                        rdfs:label ?activity_label
                              filter(lang(?activity_label) = "en")
                            }
                          '
                          template='{{>activities}}'
                        >
                          <template id="activities">
                            <strong>Occupations:</strong>
                            <ul>
                              {{#each bindings}}
                                <li>{{activity_label.value}}</li>
                              {{/each}}
                            </ul>
                          </template>

                        </semantic-query>

                      </template>
                    </semantic-if>


                    <semantic-if query='ASK{ ?event crmpc:P01_has_domain ?actor_event. ?actor_event crmpc:P02_has_range <{{subject.value}}> }'>
                      <template id='then'>
                        <semantic-query
                          query='
                          select ?event ?event_label ?role_label where {
                            ?event crm:P1_is_identified_by ?event_id;
                            crmpc:P01_has_domain ?actor_event.
                              
                            ?actor_event crmpc:P02_has_range <{{subject.value}}>;
                                        crmpc:P14.1_in_the_role_of ?role.
                            
                            ?event_id a crm:E41_Appellation;
                                      rdfs:label ?event_label.
                            
                            ?role rdfs:label ?role_label
                            
                            filter(lang(?role_label) = "en")
                          }
                          '
                          template='{{>activities}}'
                        >
                          <template id="activities">
                            <strong>Events:</strong>
                            <ul>
                              {{#each bindings}}
                                <li>
                                  <mp-event-trigger id="event-open-details" type="Component.TemplateUpdate" data='{"showdetails": true, "subject": "{{event.value}}", "type": "E5_Event"}' targets='["sidebar"]'>
                                    <a>{{event_label.value}} (Role: {{role_label.value}})</a>
                                  </mp-event-trigger>
                                </li>
                              {{/each}}
                              </ul>
                          </template>
                      </semantic-query> 
                      </template>
                    </semantic-if>



                  {{/each}}

                  
                </template>
                </semantic-query>

              </div>

            {{/ifCond}}

            {{#ifCond type "===" "E5_Event"}}

              <div>
                <semantic-query
                  query='
                    PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
                    PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                    select distinct ?subject ?name_label ?synopsys_label ?date_start where {
                      bind(<{{subject}}> as ?subject)
                      ?subject a crm:E5_Event;
                        crm:P4_has_time-span ?date;
                        crm:P1_is_identified_by ?name;
                        crm:P129i_is_subject_of ?synopsys.
                      
                      ?name a crm:E41_Appellation;
                        rdfs:label ?name_label.
                      
                      ?synopsys a crm:E73_Information_Object;
                        rdfs:label ?synopsys_label.

                      ?date a crm:E52_Time-Span;
                        crm:P82a_begin_of_the_begin ?date_start.
                     
                    }'
                  template="{{> template}}" 
                >
                <template id="template">

                  {{#each bindings}}
                    <h2 id='mapControlsTitle'>{{name_label.value}}</h2>

                    <p>Date: {{dateTimeFormat date_start.value "YYYY"}}</p>

                    <p>{{synopsys_label.value}}</p>

                    <semantic-query
                      query='
                        SELECT DISTINCT ?actor ?name_label ?role_label WHERE {
                          BIND(<{{subject.value}}> AS ?subject)
                          ?subject a crm:E5_Event;
                                  crmpc:P01_has_domain ?actor_event.
                          
                          ?actor_event a crmpc:PC14_carried_out_by;
                                      crmpc:P02_has_range ?actor;
                                      crmpc:P14.1_in_the_role_of ?role.
                          
                          ?actor crm:P1_is_identified_by ?name.
                          ?name crm:P2_has_type <https://archipelago.itatti.harvard.edu/resource/type/preferred_name>;
                                rdfs:label ?name_label.
                          
                          ?role rdfs:label ?role_label
                        }
                      '
                      template='{{>actors}}'
                    >
                        <template id="actors">
                          Actors:
                          <ol>
                            {{#each bindings}}
                            <li>
                              <mp-event-trigger id="event-open-details" type="Component.TemplateUpdate" data='{"showdetails": true, "subject": "{{actor.value}}", "type": "E39_Actor"}' targets='["sidebar"]'>
                                <a>{{name_label.value}} (Role: {{role_label.value}})</a>
                              </mp-event-trigger>
                            </li>
                            {{/each}}
                          </ol>
                        </template>

                    </semantic-query>

                  {{/each}}
                </template>



                </semantic-query>
              </div>

            {{/ifCond}}

            {{#ifCond type "===" "E22_Man-Made_Object"}}

            <div>
              <semantic-query
                query='
                  PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
                  PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                  select distinct ?subject ?name_label ?construction_date_label ?destruction_date_label where {
                    bind(<{{subject}}> as ?subject)
                    ?subject a crm:E22_Man-Made_Object;
                            rdfs:label ?name_label.
                    
                    optional {
                      ?subject crm:P108i_was_produced_by ?prod.
                      ?prod a crm:E12_Production;
                            crm:P4_has_time-span ?prod_date.

                      ?prod_date a crm:E52_Time-Span;
                                crm:P82a_begin_of_the_begin ?construction_date_label
                    }
                    
                    optional {
                    ?subject crm:P13i_was_destroyed_by ?dest.
                      ?dest a crm:E6_Destruction;
                            crm:P4_has_time-span ?dest_date.
                      ?dest_date a crm:E52_Time-Span;
                                crm:P82b_end_of_the_end ?destruction_date_label
                    }  
                  }
                '
                template="{{> template}}" 
              >
              <template id="template">

                {{#each bindings}}
                  <h3>{{name_label.value}}</h3>

                  <p>{{construction_date_label.value}}</p>

                  <p>{{destruction_date_label.value}}</p>

                {{/each}}
              </template>



              </semantic-query>
            </div>

            {{/ifCond}}

        {{else if showoptions}}
            <h2 id="mapControlsTitle">Map Controls</h2>
            <semantic-map-controls id="search-map-control" target-map-id="search-map" features-taxonomies="use,function,name" features-color-taxonomies="use,function"></semantic-map-controls>
        {{else}}
        <div>
          <h2 id="mapControlsTitle">Entities</h2>

          <semantic-search>
            <semantic-search-query-constant
              query='
                PREFIX crm: <http://www.cidoc-crm.org/cidoc-crm/>
                PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
                PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                SELECT ?subject ?type ?type_lbl ?name ?bw_start_date ?bw_end_date ?order_start_date ?order_end_date ?use_lbl ?typology_lbl WHERE {

                  {
                    BIND("1697-01-01"^^xsd:dateTime AS ?date)
                    ?subject crm:P1_is_identified_by ?bw_id;
                      rdfs:label ?name;
                      rdf:type ?type;
                      crm:P108i_was_produced_by ?prod;
                      crm:P13i_was_destroyed_by ?desc.

                    ?prod crm:P4_has_time-span ?prod_time.
                    ?prod_time crm:P82a_begin_of_the_begin ?bw_start_date.

                    ?desc crm:P4_has_time-span ?desc_time.
                    ?desc_time crm:P82b_end_of_the_end ?bw_end_date.

                    ?subject crm:P12i_was_present_at ?use.
                    ?use a crm:E5_Event;
                      crm:P2_has_type <https://archipelago.itatti.harvard.edu/resource/type/use>;
                      crm:P2_has_type ?use_type.

                    ?use_type a crm:E55_Type;
                      rdfs:label ?use_lbl.

                    ?use crm:P4_has_time-span ?use_date.
                    ?use_date crm:P82a_begin_of_the_begin ?use_date_start;
                    FILTER (?use_date_start <= ?date)

                    ?use crm:P4_has_time-span ?use_date.
                    ?use_date crm:P82b_end_of_the_end ?use_date_end.
                    FILTER (?use_date_end >= ?date)

                    FILTER (STR(?use_lbl) != "Use")
                    FILTER (lang(?use_lbl) = "en")

                    ?subject crm:P12i_was_present_at ?typology.
                    ?typology a crm:E5_Event;
                      crm:P2_has_type <https://archipelago.itatti.harvard.edu/resource/type/typology>;
                      crm:P2_has_type ?typology_type.

                    ?typology_type a crm:E55_Type;
                      rdfs:label ?typology_lbl.

                    ?typology crm:P4_has_time-span ?typology_date.

                    ?typology_date crm:P82a_begin_of_the_begin ?typology_date_start.
                    FILTER (?typology_date_start <= ?date)

                    ?typology_date crm:P82b_end_of_the_end ?typology_date_end.
                    FILTER (?typology_date_end >= ?date)

                    FILTER (STR(?typology_lbl) != "Typology")
                    FILTER (lang(?typology_lbl) = "en")

                    BIND(?bw_start_date AS ?order_start_date)
                    BIND(?bw_end_date AS ?order_end_date) 

                  }
                  UNION
                  {
                    ?subject crm:P15_was_influenced_by ?bw;
                      crm:P1_is_identified_by ?identifier;
                      crm:P4_has_time-span ?order_date;
                      rdf:type ?type.
                    ?bw crm:P108i_was_produced_by ?prod;
                        crm:P13i_was_destroyed_by ?desc.
                    
                    ?prod crm:P4_has_time-span ?prod_time.
                    ?prod_time crm:P82a_begin_of_the_begin ?bw_start_date.
                    
                    ?desc crm:P4_has_time-span ?desc_time.
                    ?desc_time crm:P82b_end_of_the_end ?bw_end_date.
                    
                    ?identifier rdf:type crm:E41_Appellation;
                      rdfs:label ?name.
                
                    ?order_date a crm:E52_Time-Span;	
                                crm:P82a_begin_of_the_begin ?order_start_date.
                    
                    BIND(?order_start_date as ?order_end_date)
                  }
                  UNION
                  {
                    ?event rdf:type crm:E5_Event;
                        crmpc:P01_has_domain ?domain;
                        crm:P15_was_influenced_by ?bw.
                
                    ?bw crm:P108i_was_produced_by ?prod;
                        crm:P13i_was_destroyed_by ?desc.
              
                    ?prod crm:P4_has_time-span ?prod_time.
                    ?prod_time crm:P82a_begin_of_the_begin ?bw_start_date.
              
                    ?desc crm:P4_has_time-span ?desc_time.
                    ?desc_time crm:P82b_end_of_the_end ?bw_end_date.
              
                    ?domain crmpc:P02_has_range ?subject.
                    ?subject rdf:type ?type;
                              crm:P1_is_identified_by ?appellation.
              
                    ?appellation crm:P2_has_type <https://archipelago.itatti.harvard.edu/resource/type/preferred_name>;
                              rdfs:label ?name.
                
                    OPTIONAL {
                      ?subject crm:P92i_was_brought_into_existence_by ?birth.
                      ?birth rdf:type crm:E67_Birth;
                              crm:P4_has_time-span ?birth_date.
                      ?birth_date crm:P82a_begin_of_the_begin ?order_start_date.
                    }
                  
                    OPTIONAL {
                      ?subject crm:P93i_was_taken_out_of_existence_by ?death.
                      ?death rdf:type crm:E69_Death;
                              crm:P4_has_time-span ?death_date.
                      ?death_date crm:P82a_begin_of_the_begin ?order_end_date.
                    }
                  
                  }
                }
              '
            ></semantic-search-query-constant>

            <semantic-search-result-holder>
              <semantic-search-result>
                <semantic-table
                  id='table'
                  query='
                    PREFIX person: <http://example.com/person/>
                    SELECT distinct ?subject ?type ?type_lbl ?name ?order_start_date ?order_end_date ?use_lbl ?typology_lbl where {
                      bind("1697-01-01"^^xsd:dateTime as ?date).

                      bind(replace(?subject, "http://www.cidoc-crm.org/cidoc-crm/", "") as ?subject)
                      bind(replace(str(?type), "http://www.cidoc-crm.org/cidoc-crm/", "") AS ?type_lbl)

                      filter(?bw_start_date <= ?date)
                      filter(?bw_end_date >= ?date)
                    } ORDER BY ASC(?order_start_date)
                  '
                  tuple-template='{{>resultTemplate}}'
                  options='{"showFilter": false}'
                >
                  <template id='resultTemplate'>
                    
                    {{#ifCond type_lbl.value "===" "E39_Actor"}} 
                    
                      <div class="panel panel-default text-center w-100 {{type_lbl.value}}" title="{{subject.value}}">
                        <div class="panel-body ">
                          <div class="row">
                            <div class="col-sm-3">
                              <img class="navigator-icon" src="../../assets/icons/{{type_lbl.value}}.svg" alt="">
                            </div>
                            <div class="col-sm-9 text-left">

                              <mp-event-trigger id='event-open-details' type='Component.TemplateUpdate' data='{"showdetails": true, "subject": "{{subject.value}}", "type": "{{type_lbl.value}}"}' targets='["sidebar"]'>
                                <a><strong>{{name.value}}</strong></a>
                              </mp-event-trigger>

                              {{#if order_start_date }}
                                <br>
                                {{dateTimeFormat order_start_date.value "YYYY"}} {{#if order_end_date}} - {{dateTimeFormat order_end_date.value "YYYY"}} {{/if}}
                              {{/if}}

                                <semantic-query
                                  query='
                                    SELECT DISTINCT ?subject ?activity_lbl WHERE {
                                      bind(<{{subject.value}}> as ?subject)
                                      
                                      ?subject crm:P14i_performed ?activity.
                                      ?activity a frbroo:F51_Pursuit;
                                        rdfs:label ?activity_lbl
                                      
                                      filter(lang(?activity_lbl) = "en")
                                    }
                                  '
                                  template='{{>roles}}'
                                >

                                  <template id="roles">
                                    {{#each bindings}}
                                      <br>{{activity_lbl.value}}
                                    {{/each}}
                                    
                                  </template>

                                </semantic-query>

                              {{log subject.value}}

                            </div>
                          </div>
                        </div>
                      </div>

                    {{/ifCond}}

                    {{#ifCond type_lbl.value "===" "E22_Man-Made_Object"}} 
                    
                      <div class="panel panel-default text-center w-100 {{type_lbl.value}}" title="{{subject.value}}">
                        <div class="panel-body ">
                          <div class="row">
                            <div class="col-sm-3">
                              <p><img class="navigator-icon" src="../../assets/icons/{{type_lbl.value}}.svg" alt=""></p>
                            </div>
                            <div class="col-sm-9 text-left">
                              
                              <mp-event-trigger id="event-open-details" type="Component.TemplateUpdate" data='{"showdetails": true, "subject": "{{subject.value}}", "type": "{{type_lbl.value}}"}' targets='["sidebar"]'>
                                <a><strong>{{typology_lbl.value}}</strong></h3></a>
                              </mp-event-trigger>

                              <br>
                              Construction: {{dateTimeFormat order_start_date.value "YYYY"}}
                              <br>
                              Demolition: {{dateTimeFormat order_end_date.value "YYYY"}}
                              <br>
                              Function: Private
                              <br>
                              Use: {{use_lbl.value}}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                    {{/ifCond}}

                    {{#ifCond type_lbl.value "===" "E5_Event"}} 
                      
                      <div class="panel panel-default text-center w-100 {{type_lbl.value}}" title="{{subject.value}}">
                        <div class="panel-body ">
                          <div class="row">
                            <div class="col-sm-3">
                              <img class="navigator-icon" src="../../assets/icons/{{type_lbl.value}}.svg" alt="">
                            </div>
                            <div class="col-sm-9 text-left">
                              <mp-event-trigger id="event-open-details" type="Component.TemplateUpdate" data='{"showdetails": true, "subject": "{{subject.value}}", "type": "{{type_lbl.value}}"}' targets='["sidebar"]'>
                                <a><strong>{{name.value}}</strong></a>
                              </mp-event-trigger>

                              <br>
                              {{#if order_start_date}}
                              {{dateTimeFormat order_start_date.value "YYYY"}}
                              {{/if}}
                            </div>
                          </div>
                        </div>
                      </div>
                      
                    {{/ifCond}}

                </template>
                </semantic-table>
              </semantic-search-result>
            </semantic-search-result-holder>

          </semantic-search>

        </div>
        {{/if}}
    </template>
</mp-event-target-template-render>
<style>
  #navigatorContainer{
    width: 400px!important;
  }

 #navigatorContainer a{
    color: #3498db!important;
  }
  
  #navigatorContainer h2{
    text-align: center;
  }

  div.E5_Event{
    border-left: 5px solid #F58F84!important;
  }

  div.E22_Man-Made_Object{
    border-left: 5px solid #26A65B!important;
  }

  div.E39_Actor{
    border-left: 5px solid #FFA400!important;
  }

  .navigator-icon{
    height: 30px;
  }

  .w-100{
    width: 100%!important;
  }
</style>
