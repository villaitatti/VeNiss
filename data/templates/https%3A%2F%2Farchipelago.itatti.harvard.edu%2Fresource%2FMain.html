<link rel="stylesheet" href="../../assets/styles/archipelago-main.css" />
<div id="mainContainer">

  <div class="maptoolbar flexrows">
    <div id="maptoolbarFirst" class="">
      <h6 id="maptoolbarTitle">Interactive Narrative</h6>
      <div class="pull-right">
        <mp-event-trigger
          id="event-trigger2"
          type="Component.TemplateUpdate"
          data='{"showbasemaps": true}'
          targets='["sidebar"]'
        >
          <em id="basemapsBtn" class="fa fa-globe toolbarIcon"></em>
        </mp-event-trigger>
        <mp-event-trigger
          id="event-trigger3"
          type="Component.TemplateUpdate"
          data='{"showhistoricalmaps": true}'
          targets='["sidebar"]'
        >
          <em id="historicalmapsBtn" class="fa fa-map toolbarIcon"></em>
        </mp-event-trigger>
        <mp-event-trigger
          id="event-trigger4"
          type="Component.TemplateUpdate"
          data='{"showoptions": true}'
          targets='["sidebar"]'
        >
          <em id="optionsBtn" class="fa fa-cogs toolbarIcon"></em>
        </mp-event-trigger>
        <mp-event-trigger
          id="event-trigger5"
          type="Component.TemplateUpdate"
          data='{"showentities": true}'
          targets='["sidebar"]'
        >
          <em id="entitiesBtn" class="fa fa-id-card toolbarIcon"></em>
        </mp-event-trigger>
      </div>
    </div>
    <div id="maptoolbarSecond" class=""></div>
  </div>

  <div id="mapNavigatorContainer" class="flexrows">
    
    <!-- Event to handle bounding box search-->
    <mp-event-proxy
      id="on-moveend-search-map"
      on-event-source="search-map"
      on-event-type="SemanticMap.BoundingBoxChanged"
      proxy-event-type="SemanticSearch.QueryConstant.SetParameters"
      proxy-targets='["search-map-query"]'
    >
    </mp-event-proxy>

    <!-- Structured search with geospatial -->
    <semantic-context repository="ephedra">
      <semantic-search
        search-profile='{
          "categories": [{
            "iri": "<https://archipelago.itatti.harvard.edu/arconto#Event>",
            "label": "Event",
            "thumbnail": "../../assets/icons/Event.svg"
          },
          {
            "iri": "<https://archipelago.itatti.harvard.edu/arconto#Builtwork>",
            "label": "Builtwork",
            "thumbnail": "../../assets/icons/Builtwork.svg"
          }],
          "relations": [{
            "iri": "<https://archipelago.itatti.harvard.edu/arconto#related_to>",
            "label": "Related to",
            "hasDomain": "<https://archipelago.itatti.harvard.edu/arconto#Event>",
            "hasRange": "<https://archipelago.itatti.harvard.edu/arconto#Builtwork>"
          }]
        }'
      >

        <semantic-search-query-constant

          id="search-map-query"
          parameters='{
            "southWestLat": {"value": "1368358.959761288"},
            "southWestLon": {"value": "5692238.026840036"},
            "northEstLat": {"value": "1371414.0522355612"},
            "northEstLon": {"value": "5693523.1243780805"}
          }'
          query='
            PREFIX archipelago: <http://www.researchspace.org/resource/system/service/archipelago#>
            PREFIX rssqlsail: <http://www.researchspace.org/resource/system/sql#>
            SELECT DISTINCT ?subject ?bw_id ?wkt WHERE {
              service <http://www.researchspace.org/resource/system/repository/federation#geosql> {
                ?root rssqlsail:hasQueryId "production";	
                  archipelago:wkt ?wkt;
                  archipelago:bw_id ?bw_id;
                  archipelago:minX ?southWestLat;
                  archipelago:minY ?southWestLon;
                  archipelago:maxX ?northEstLat;
                  archipelago:maxY ?northEstLon
              }                                        
              BIND(IRI(CONCAT("https://archipelago.itatti.harvard.edu/resource/builtwork/", ?bw_id)) as ?subject)
              BIND("1697-01-01"^^xsd:dateTime AS ?date)

              ?subject crm:P108i_was_produced_by ?prod;
                crm:P13i_was_destroyed_by ?desc.

              ?prod crm:P4_has_time-span ?prod_time.
              ?prod_time crm:P82a_begin_of_the_begin ?bw_start_date.
              FILTER (?bw_start_date <= ?date)

              ?desc crm:P4_has_time-span ?desc_time.
              ?desc_time crm:P82b_end_of_the_end ?bw_end_date.
              FILTER (?bw_end_date > ?date)
            }'
        ></semantic-search-query-constant>

        <semantic-search-result-holder>
          <div id="mapNavigatorRow">
            <div id="mapContainer">[[> arc:Map ]]</div>
            <div id="navigatorContainer">[[> arc:Navigator ]]</div>
          </div>
        </semantic-search-result-holder>
      </semantic-search>
    </semantic-context>
  </div>

</div>
