<!-- try (TupleQueryResult tqr = con.prepareTupleQuery("SELECT * WHERE { ?a ?b ?c optional { ?root <http://www.researchspace.org/resource/system/sql#hasQueryId> 'q2'} } LIMIT 1").evaluate()) { -->
    <div id="mainContainer">
        <div class="maptoolbar flexrows">
            <div id="maptoolbarFirst" class="">
                <h6 id="maptoolbarTitle">Interactive Narrative</h6>
                <div class="pull-right">
                    <mp-event-trigger id='event-trigger2' type='Component.TemplateUpdate' data='{"showbasemaps": true}' targets='["sidebar"]'>
                        <i id="basemapsBtn" class="fa fa-globe toolbarIcon"></i>
                    </mp-event-trigger>
                    <mp-event-trigger id='event-trigger3' type='Component.TemplateUpdate' data='{"showhistoricalmaps": true}' targets='["sidebar"]'>
                        <i id="historicalmapsBtn" class="fa fa-map toolbarIcon"></i>
                    </mp-event-trigger>
                    <mp-event-trigger id='event-trigger4' type='Component.TemplateUpdate' data='{"showoptions": true}' targets='["sidebar"]'>
                        <i id="optionsBtn" class="fa fa-cogs toolbarIcon"></i>
                    </mp-event-trigger>
                    <mp-event-trigger id='event-trigger5' type='Component.TemplateUpdate' data='{"showentities": true}' targets='["sidebar"]'>
                        <i id="entitiesBtn" class="fa fa-id-card toolbarIcon"></i>
                    </mp-event-trigger>
                </div>
            </div>
            <div id="maptoolbarSecond" class="">
    
            </div>
        </div>
        <div id="mapNavigatorContainer" class="flexrows">

    
        <!-- Event to handle bounding box search-->
        <mp-event-proxy
                id='on-moveend-search-map'
                on-event-source='search-map'
                on-event-type='SemanticMap.BoundingBoxChanged'
                proxy-event-type='SemanticSearch.QueryConstant.SetParameters'
                proxy-targets='["search-map-query"]'>
        </mp-event-proxy>

        <!-- Structured search with geospatial -->
        <semantic-context repository='ephedra'>
            <semantic-search>

                <semantic-search-query-constant
                    id='search-map-query'
                    parameters='{
                        "southWestLat": {
                            "value": "1368358.959761288"
                        },
                        "southWestLon": {
                            "value": "5692238.026840036"
                        },
                        "northEstLat": {
                            "value": "1371414.0522355612"
                        },
                        "northEstLon": {
                            "value": "5693523.1243780805"
                        }
                    }'
                    query='
                        PREFIX archipelago: <http://www.researchspace.org/resource/system/service/archipelago#>
                        PREFIX rssqlsail: <http://www.researchspace.org/resource/system/sql#>
                        SELECT ?subject ?bw_id ?wkt WHERE {
                            service <http://www.researchspace.org/resource/system/repository/federation#geosql> {
                              ?root rssqlsail:hasQueryId "test";	
                                archipelago:wkt ?wkt;
                                archipelago:bw_id ?bw_id;
                                archipelago:minX ?southWestLat;
                                archipelago:minY ?southWestLon;
                                archipelago:maxX ?northEstLat;
                                archipelago:maxY ?northEstLon
                            }                                        
                            BIND(IRI(CONCAT("https://archipelago.itatti.harvard.edu/resource/built_work/", ?bw_id)) as ?subject)
                        }'
                ></semantic-search-query-constant>

                <div id="mapNavigatorRow">
                  <div id="mapContainer">
                    [[> arc:Map ]]
                  </div>

                  <div id="navigatorContainer">
                    [[> arc:Navigator ]]
                  </div>
                </div>

            </semantic-search>
        </semantic-context>

        </div>

    </div>
    
    
    <style>
        html,
        body {
            height: 100%;
            margin: 0
        }
        #mainContainer {
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            width: 100%;
        }
    
        .maptoolbar {
            display: flex;
            flex-direction: row;
        }
    
        #maptoolbarFirst {
            flex: 1;
        }
    
    
    
        #mapContainer {
            height: calc(100vh - 88px);
        }
    
        #mapContainer > div:nth-of-type(1)
        {
            height: 100%;
        }
    
        #mapNavigatorContainer {
            flex: 1;
            background: #ff0029;
            position: relative;
        }
    
        #mapNavigatorRow {
            display: flex;
            position:absolute;
            height: 100%;
            width: 100%
        }
    
        #mapContainer {
            flex: 1;
            background: rgba(0, 141, 237, 0)
        }
    
        #navigatorContainer {
            padding: 15px;
            text-wrap: normal;
            overflow-wrap: break-word;
            overflow-y: scroll;
            height: calc(100vh - 88px);
            background-color: white;
        }
    
        #maptoolbarSecond, #navigatorContainer {
            width: 320px;
        }
    
        .system-spinner:nth-of-type(n+2) {
            display:none !important;
        }
    
        #narrativeHolder {
            height: calc(100vh - 88px);
            position: fixed;
            top: 88px;
            left: 30px;
            width: 25%;
            max-width: 500px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.91);
            padding: 20px;
            text-align: justify;
            overflow-y: scroll;
            /* font-family: 'Playfair Display', serif;
            font-weight: lighter; */
        }
    
        #narrativeHolder > p {
            font-size: 11pt;
        }
    
        #narrativeHolder::-webkit-scrollbar {
            display: none;
        }
    
        #narrativeTitle {
            margin-top: 0;
            font-size: 20pt;
            text-align: center;
            color: var(--color-header-bg);
        }
    
        .narrativeLink {
            color: var(--color-header-bg);
            text-decoration: underline;
            font-weight: bold;
            cursor: pointer;
        }
    
    
        .ol-zoom {
            top: auto;
            left: auto;
            bottom: 20px;
            right: 8px;
        }
    
        #narrativeImage {
            width: 50%;
            margin: 15px 25% 25px 25%;
            border: 1px solid var(--color-header-bg);
        }
    
        .or-spacer {
            width: 300px;
            margin-left: 50%;
            transform:translate(-50%);
            position: relative;
        }
        .or-spacer .mask {
            overflow: hidden;
            height: 20px;
        }
        .or-spacer .mask:after {
            content: '';
            display: block;
            margin: -25px auto 0;
            width: 100%;
            height: 25px;
            border-radius: 125px / 12px;
            box-shadow: 0 0 8px black;
        }
    
        .toolbarIcon {
            cursor: pointer;
        }
    
    
    </style>

    <!--
      ?bw crm:P12i_was_present_at ?function_node.
      ?function_node a crm:E5_Event;
        rdfs:label ?function;
        crm:P4_has_time-span ?function_date.
      
      ?function_date crm:P82a_begin_of_the_begin ?function_date_start.
      filter(?function_date_start <= ?date)
      
      optional {
        ?function_date crm:P82b_end_of_the_end ?function_date_end.
        filter(?function_date_end >= ?date) 
      }
      
      ?bw crm:P12i_was_present_at ?use_node.
      ?use_node crm:P2_has_type <https://archipelago.itatti.harvard.edu/resource/type/use>, ?use_type.
      ?use_type rdf:type crm:E55_Type;
        rdfs:label ?use.
      ?use_node crm:P4_has_time-span ?use_date.
      ?use_date crm:P82a_begin_of_the_begin ?use_date_start;
        crm:P82b_end_of_the_end ?use_date_end.
      
      FILTER(?use_date_start <= ?date)
      FILTER(?use_date_end >= ?date)
      FILTER((STR(?use)) != "Use")
      FILTER((LANG(?use)) = "en")
      
      optional {
        ?bw crm:P12i_was_present_at ?typology_node.
        ?typology_node crm:P2_has_type <https://archipelago.itatti.harvard.edu/resource/type/typology>, ?typology_type.
        ?typology_type rdf:type crm:E55_Type;
          rdfs:label ?typology.
        ?typology_node crm:P4_has_time-span ?typology_date.
        ?typology_date crm:P82a_begin_of_the_begin ?typology_date_start;
          crm:P82b_end_of_the_end ?typology_date_end.
    
        FILTER(?typology_date_start <= ?date)
        FILTER(?typology_date_end >= ?date)
        FILTER((STR(?typology)) != "Typology")
        FILTER((LANG(?typology)) = "en")
      }-->